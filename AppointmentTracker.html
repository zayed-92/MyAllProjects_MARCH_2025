<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المواعيد</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { direction: rtl; text-align: right; background-color: #f8f9fa; }
        .container { max-width: 800px; margin-top: 20px; }
        .hidden-details { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-center">إدارة المواعيد</h2>
        <form id="appointmentForm" class="mb-4">
            <div class="mb-3">
                <label class="form-label">التاريخ:</label>
                <input type="date" class="form-control" id="date" required>
            </div>
            <div class="mb-3">
                <label class="form-label">التفاصيل:</label>
                <textarea class="form-control" id="details" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">إضافة موعد</button>
        </form>

        <h3 class="text-center">قائمة المواعيد</h3>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>التاريخ</th>
                    <th>تفاصيل</th>
                    <th>إجراء</th>
                </tr>
            </thead>
            <tbody id="appointmentsTable">
            </tbody>
        </table>
    </div>

    <script>
        $(document).ready(function () {
            // تحميل بيانات المواعيد من Google Sheets بتنسيق JSON
            const sheetUrl = 'https://spreadsheets.google.com/feeds/list/2PACX-1vQXK13GM8iBXW3m9jgBOioPKNqPma8t510YNbjFn3A8kO0yKiVD_vZMZLLMtHmd5J4SCWnZ6IqyED7g/od6/public/values?alt=json';

            // جلب البيانات
            $.getJSON(sheetUrl, function(data) {
                let appointments = data.feed.entry;
                appointments.forEach(function(appointment) {
                    let date = appointment.gsx$التاريخ.$t;
                    let details = appointment.gsx$التفاصيل.$t;
                    let newRow = `<tr>
                        <td>${date}</td>
                        <td><span class="preview">${details.substring(0, 20)}...</span>
                            <span class="hidden-details">${details}</span>
                        </td>
                        <td>
                            <button class="btn btn-info btn-sm view-details" data-date="${date}" data-details="${details}">عرض</button>
                            <button class="btn btn-warning btn-sm edit" data-date="${date}" data-details="${details}">تعديل</button>
                            <button class="btn btn-danger btn-sm delete">حذف</button>
                            <button class="btn btn-success btn-sm add-to-calendar" data-date="${date}" data-details="${details}">إضافة إلى التقويم</button>
                        </td>
                    </tr>`;
                    $("#appointmentsTable").append(newRow);
                });
            });

            $("#appointmentForm").submit(function (event) {
                event.preventDefault();
                let date = $("#date").val();
                let details = $("#details").val();
                let newRow = `<tr>
                    <td>${date}</td>
                    <td><span class="preview">${details.substring(0, 20)}...</span>
                        <span class="hidden-details">${details}</span>
                    </td>
                    <td>
                        <button class="btn btn-info btn-sm view-details" data-date="${date}" data-details="${details}">عرض</button>
                        <button class="btn btn-warning btn-sm edit" data-date="${date}" data-details="${details}">تعديل</button>
                        <button class="btn btn-danger btn-sm delete">حذف</button>
                        <button class="btn btn-success btn-sm add-to-calendar" data-date="${date}" data-details="${details}">إضافة إلى التقويم</button>
                    </td>
                </tr>`;
                $("#appointmentsTable").append(newRow);
                $("#appointmentForm")[0].reset();
            });

            $(document).on("click", ".view-details", function () {
                let date = $(this).data("date");
                let details = $(this).data("details");
                let url = `details.html?date=${encodeURIComponent(date)}&details=${encodeURIComponent(details)}`;
                window.open(url, "_blank");
            });

            $(document).on("click", ".delete", function () {
                $(this).closest("tr").remove();
            });

            $(document).on("click", ".edit", function () {
                let date = $(this).data("date");
                let details = $(this).data("details");
                $("#date").val(date);
                $("#details").val(details);
                $("#appointmentForm").submit(function (event) {
                    event.preventDefault();
                    $(this).closest("tr").find("td:eq(0)").text($("#date").val());
                    $(this).closest("tr").find("td:eq(1)").html(`<span class="preview">${$("#details").val().substring(0, 20)}...</span><span class="hidden-details">${$("#details").val()}</span>`);
                    $(this).closest("tr").find(".view-details").data("date", $("#date").val()).data("details", $("#details").val());
                    $(this).closest("tr").find(".edit").data("date", $("#date").val()).data("details", $("#details").val());
                    $(this).closest("tr").find(".add-to-calendar").data("date", $("#date").val()).data("details", $("#details").val());
                    $(this)[0].reset();
                });
            });

            $(document).on("click", ".add-to-calendar", function () {
                let date = $(this).data("date");
                let details = $(this).data("details");
                let eventDate = new Date(date);
                let startTime = eventDate.toISOString().slice(0, 16); // تنسيق: YYYY-MM-DDTHH:MM
                let calendarUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(details)}&dates=${startTime}/${startTime}&details=${encodeURIComponent(details)}`;
                window.open(calendarUrl, "_blank");
            });
        });
    </script>
</body>
</html>
